<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>mrpack → target-version checker</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    body { font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; padding: 1rem; }
    label,input,button,select { font-size: 1rem; }
    table { border-collapse: collapse; margin-top: 1rem; width: 100%; }
    th, td { border: 1px solid #ddd; padding: .5rem; text-align: left; vertical-align: top; }
    th { background: #f6f6f6; }
    .ok { color: #157347; }
    .no { color: #b02a37; }
    .muted { color: #666; }
    pre { white-space: pre-wrap; }
    .controls { display:flex; gap:1rem; align-items:center; flex-wrap: wrap; }
  </style>
</head>
<body>
  <h1>Modrinth mrpack → version availability</h1>

  <div class="controls">
    <div>
      <label for="file">mrpack/zip:&nbsp;</label>
      <input type="file" id="file" accept=".mrpack,.zip" />
    </div>
    <div>
      <label for="mc">Target MC:&nbsp;</label>
      <select id="mc" disabled><option>Loading…</option></select>
    </div>
    <div>
      <label for="loader">Loader:&nbsp;</label>
      <select id="loader">
        <option value="fabric" selected>fabric</option>
        <option value="quilt">quilt</option>
        <option value="forge">forge</option>
        <option value="neoforge">neoforge</option>
      </select>
      <span class="muted">(* resource packs auto-use loader “minecraft”)</span>
    </div>
    <button id="run">Check</button>
  </div>

  <div id="summary" class="muted" style="margin-top:.75rem;"></div>
  <div id="table"></div>
  <details style="margin-top:1rem;">
    <summary>Raw results (debug)</summary>
    <pre id="raw"></pre>
  </details>

  <!-- Local JSZip -->
  <script src="./jszip-dist/jszip.min.js"></script>
  <script>
    const MAX_CONCURRENCY = 6;
    const $ = (id) => document.getElementById(id);
    const fileInput = $("file");
    const runBtn = $("run");
    const mcSelect = $("mc");
    const loaderSelect = $("loader");
    const outSummary = $("summary");
    const outRaw = $("raw");

    // 1) Populate MC versions dynamically
    (async function populateMcVersions(){
      try {
        mcSelect.disabled = true;
        mcSelect.innerHTML = `<option>Loading…</option>`;
        const res = await fetch("https://api.modrinth.com/v2/tag/game_version");
        if (!res.ok) throw new Error("Failed to fetch game versions");
        const tags = await res.json();

        const clean = tags
          .map(t => t.version || t)
          .filter(v => /^\d+\.\d+(\.\d+)?$/.test(v));

        clean.sort((a, b) => {
          const pa = a.split('.').map(n=>parseInt(n,10));
          const pb = b.split('.').map(n=>parseInt(n,10));
          while (pa.length < 3) pa.push(0);
          while (pb.length < 3) pb.push(0);
          for (let i=0;i<3;i++){ if (pb[i] !== pa[i]) return pb[i]-pa[i]; }
          return 0;
        });

        mcSelect.innerHTML = clean.map(v => `<option value="${v}">${v}</option>`).join("");
        mcSelect.disabled = false;
      } catch (e) {
        mcSelect.innerHTML = `<option value="1.21.4">1.21.4</option>`;
        mcSelect.disabled = false;
        console.warn("Falling back to static MC version list:", e);
      }
    })();

    // 2) Main flow
    runBtn.addEventListener("click", async () => {
      const file = fileInput.files?.[0];
      if (!file) { alert("Choose a .mrpack (or .zip) first."); return; }
      const TARGET_MC = mcSelect.value;
      const PACK_LOADER = loaderSelect.value;

      $("table").innerHTML = "";
      outRaw.textContent = "";
      outSummary.textContent = "Reading pack…";

      try {
        // Read mrpack and parse index
        const zipAb = await file.arrayBuffer();
        const zip = await JSZip.loadAsync(zipAb);
        const indexFile = zip.file("modrinth.index.json");
        if (!indexFile) { outSummary.textContent = "No modrinth.index.json found."; return; }
        const index = JSON.parse(await indexFile.async("string"));

        // *** NEW: current MC from pack dependencies ***
        const PACK_MC = index?.dependencies?.minecraft || "-";

        // Collect SHA-1s and remember paths
        const sha1ToPath = new Map();
        const sha1s = [];
        for (const f of index.files || []) {
          const sha1 = f?.hashes?.sha1;
          if (sha1) { sha1s.push(sha1); sha1ToPath.set(sha1, f.path || ""); }
        }
        if (!sha1s.length) { outSummary.textContent = "No file hashes in modrinth.index.json."; return; }

        outSummary.textContent = `Found ${sha1s.length} entries. Resolving projects…`;

        // Hash → Version (map of sha1 to version object)
        const versionMap = await fetch("https://api.modrinth.com/v2/version_files", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ hashes: sha1s, algorithm: "sha1" })
        }).then(r => r.json());

        // Collapse to unique projects (keep representative)
        const projectEntries = new Map(); // project_id -> { anyVersion, exampleSha1 }
        for (const [sha1, ver] of Object.entries(versionMap)) {
          if (!ver || !ver.project_id) continue;
          if (!projectEntries.has(ver.project_id)) {
            projectEntries.set(ver.project_id, { anyVersion: ver, exampleSha1: sha1 });
          }
        }
        const projectIds = [...projectEntries.keys()];
        if (!projectIds.length) {
          outSummary.textContent = "Couldn’t resolve any project IDs from hashes.";
          outRaw.textContent = JSON.stringify(versionMap, null, 2);
          return;
        }

        // Helper: detect loader ("minecraft" for resourcepacks/, else selected)
        function loaderFor(projectId) {
          const { exampleSha1 } = projectEntries.get(projectId) || {};
          const path = sha1ToPath.get(exampleSha1) || "";
          return path.startsWith("resourcepacks/") ? "minecraft" : PACK_LOADER;
        }

        // Fetch project metadata (for names/slugs)
        async function getProject(projectId) {
          const r = await fetch(`https://api.modrinth.com/v2/project/${projectId}`);
          if (!r.ok) return null;
          return r.json();
        }

        // Fetch filtered versions for target MC+loader, pick best
        async function getBestTargetVersion(projectId, mc, loader) {
          const url = new URL(`https://api.modrinth.com/v2/project/${projectId}/version`);
          url.searchParams.set("game_versions", JSON.stringify([mc]));
          url.searchParams.set("loaders", JSON.stringify([loader]));
          const res = await fetch(url);
          if (!res.ok) throw new Error(`versions ${projectId}: ${res.status}`);
          const arr = await res.json();
          if (!Array.isArray(arr) || !arr.length) return null;

          const tier = v => v.version_type === "release" ? 3 : v.version_type === "beta" ? 2 : 1;
          arr.sort((a, b) => {
            const t = tier(b) - tier(a);
            if (t) return t;
            return new Date(b.date_published) - new Date(a.date_published);
          });
          return arr[0];
        }

        // Concurrency limiter
        async function mapLimit(items, limit, fn) {
          const out = new Array(items.length);
          let i = 0;
          const running = new Set();
          async function run(idx) {
            const p = fn(items[idx]).then(v => out[idx] = v).finally(() => running.delete(p));
            running.add(p);
            await p;
          }
          while (i < items.length) {
            while (running.size < limit && i < items.length) await run(i++);
            if (running.size) await Promise.race(running);
          }
          return out;
        }

        outSummary.textContent = `Checking ${projectIds.length} projects for ${TARGET_MC}…`;

        const rows = await mapLimit(projectIds, MAX_CONCURRENCY, async (pid) => {
          const rep = projectEntries.get(pid)?.anyVersion;
          const [proj, best] = await Promise.all([
            getProject(pid),
            getBestTargetVersion(pid, TARGET_MC, loaderFor(pid))
          ]);
          return {
            project_id: pid,
            name: proj?.title || rep?.name || "(unknown)",
            slug: proj?.slug,
            current_version_number: rep?.version_number || "-",
            current_mc: PACK_MC, // <-- single value from pack dependencies
            current_loaders: Array.isArray(rep?.loaders) ? rep.loaders.join(", ") : "-",
            target_loader: loaderFor(pid),
            target_available: !!best,
            target_version_number: best?.version_number || "-",
            target_mc: TARGET_MC,
            target_date: best?.date_published || null,
            download_url: best?.files?.[0]?.url || null
          };
        });

        renderTable(rows);
        console.table(rows.map(r => ({
          Name: r.name,
          "Current Mod": r.current_version_number,
          "Current MC": r.current_mc,
          Loader: r.target_loader,
          ["Has " + r.target_mc]: r.target_available ? "✅" : "❌",
          "Target Mod": r.target_version_number,
          "Published": r.target_date ? new Date(r.target_date).toLocaleDateString() : "-",
          Slug: r.slug
        })));

        outRaw.textContent = JSON.stringify(rows, null, 2);
        outSummary.textContent = `Done. ${rows.filter(r => r.target_available).length}/${rows.length} have a ${TARGET_MC} build.`;
      } catch (err) {
        console.error(err);
        outSummary.textContent = "Error: " + (err?.message || err);
      }
    });

    function renderTable(rows) {
      const container = document.getElementById("table");
      if (!rows?.length) { container.innerHTML = ""; return; }

      const targetMc = rows[0]?.target_mc || "(target)";
      const html = [
        "<table>",
        "<thead><tr>",
        "<th>Name</th>",
        "<th>Current mod</th>",
        "<th>Current MC</th>",
        "<th>Loader</th>",
        `<th>Has ${escapeHtml(targetMc)}</th>`,
        "<th>Target mod</th>",
        "<th>Published</th>",
        "<th>Download</th>",
        "</tr></thead><tbody>",
        ...rows.map(r => {
          const ok = r.target_available;
          const date = r.target_date ? new Date(r.target_date).toLocaleDateString() : "-";
          const dl = r.download_url ? `<a href="${r.download_url}" target="_blank" rel="noreferrer">.jar</a>` : "";
          return `<tr>
            <td>${escapeHtml(r.name || "(unknown)")}</td>
            <td>${escapeHtml(r.current_version_number)}</td>
            <td>${escapeHtml(r.current_mc)}</td>
            <td>${escapeHtml(r.target_loader || "-")}</td>
            <td class="${ok ? "ok" : "no"}">${ok ? "✅" : "❌"}</td>
            <td>${escapeHtml(r.target_version_number)}</td>
            <td>${date}</td>
            <td>${dl}</td>
          </tr>`;
        }),
        "</tbody></table>"
      ].join("");
      container.innerHTML = html;
    }

    function escapeHtml(s) {
      return String(s).replace(/[&<>"']/g, c => ({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[c]));
    }
  </script>
</body>
</html>